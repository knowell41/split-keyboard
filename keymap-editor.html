<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Dactyl Manuform 4×6 — Keymap Editor</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { background: #0a0a15; overflow-x: hidden; }
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
  @keyframes slideUp { from { opacity:0; transform: translateY(8px); } to { opacity:1; transform: translateY(0); } }
</style>
</head>
<body>
<div id="root"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<script type="text/babel">
const { useState, useRef, useCallback, useEffect } = React;

const UNIT = 58;
const GAP = 4;
const KEY_R = 7;
const STEP = UNIT + GAP;

const DEFAULT_LAYOUT = [
  { label: "ESC", row: 0, col: 0, x: 0, y: 0.75 },
  { label: "Q", row: 0, col: 1, x: 1, y: 0.25 },
  { label: "W", row: 0, col: 2, x: 2, y: 0 },
  { label: "E", row: 0, col: 3, x: 3, y: 0.15 },
  { label: "R", row: 0, col: 4, x: 4, y: 0.3 },
  { label: "T", row: 0, col: 5, x: 5, y: 0.45 },
  { label: "Y", row: 0, col: 6, x: 9, y: 0.45 },
  { label: "U", row: 0, col: 7, x: 10, y: 0.3 },
  { label: "I", row: 0, col: 8, x: 11, y: 0.15 },
  { label: "O", row: 0, col: 9, x: 12, y: 0 },
  { label: "P", row: 0, col: 10, x: 13, y: 0.25 },
  { label: "BSPC", row: 0, col: 11, x: 14, y: 0.75 },
  { label: "TAB", row: 1, col: 0, x: 0, y: 1.75 },
  { label: "A", row: 1, col: 1, x: 1, y: 1.25 },
  { label: "S", row: 1, col: 2, x: 2, y: 1 },
  { label: "D", row: 1, col: 3, x: 3, y: 1.15 },
  { label: "F", row: 1, col: 4, x: 4, y: 1.3 },
  { label: "G", row: 1, col: 5, x: 5, y: 1.45 },
  { label: "H", row: 1, col: 6, x: 9, y: 1.45 },
  { label: "J", row: 1, col: 7, x: 10, y: 1.3 },
  { label: "K", row: 1, col: 8, x: 11, y: 1.15 },
  { label: "L", row: 1, col: 9, x: 12, y: 1 },
  { label: ";", row: 1, col: 10, x: 13, y: 1.25 },
  { label: "'", row: 1, col: 11, x: 14, y: 1.75 },
  { label: "SHFT", row: 2, col: 0, x: 0, y: 2.75 },
  { label: "Z", row: 2, col: 1, x: 1, y: 2.25 },
  { label: "X", row: 2, col: 2, x: 2, y: 2 },
  { label: "C", row: 2, col: 3, x: 3, y: 2.15 },
  { label: "V", row: 2, col: 4, x: 4, y: 2.3 },
  { label: "B", row: 2, col: 5, x: 5, y: 2.45 },
  { label: "N", row: 2, col: 6, x: 9, y: 2.45 },
  { label: "M", row: 2, col: 7, x: 10, y: 2.3 },
  { label: ",", row: 2, col: 8, x: 11, y: 2.15 },
  { label: ".", row: 2, col: 9, x: 12, y: 2 },
  { label: "/", row: 2, col: 10, x: 13, y: 2.25 },
  { label: "SHFT", row: 2, col: 11, x: 14, y: 2.75 },
  { label: "FN", row: 3, col: 1, x: 1, y: 3.75 },
  { label: "ALT", row: 3, col: 2, x: 2, y: 3.55 },
  { label: "GUI", row: 3, col: 3, x: 3, y: 3.45, r: 10, rx: 3.5, ry: 6 },
  { label: "SPC", row: 3, col: 4, x: 4, y: 3.45, r: 20, rx: 4.5, ry: 6 },
  { label: "LCTL", row: 3, col: 5, x: 5, y: 3.45, r: 30, rx: 5.5, ry: 6 },
  { label: "RCTL", row: 3, col: 6, x: 9, y: 3.45, r: -30, rx: 8.5, ry: 6 },
  { label: "ENT", row: 3, col: 7, x: 10, y: 3.45, r: -20, rx: 9.5, ry: 6 },
  { label: "ALT", row: 3, col: 8, x: 11, y: 3.45, r: -10, rx: 10.5, ry: 6 },
  { label: "[", row: 3, col: 9, x: 12, y: 3.55 },
  { label: "]", row: 3, col: 10, x: 13, y: 3.75 },
];

const LAYER_COLORS = [
  { name: "Base", accent: "#e94560", keyCap: "#16213e", keyBorder: "#0f3460", textColor: "#e0e0e0", highlight: "#e94560" },
  { name: "Lower", accent: "#0ea5e9", keyCap: "#0c2d48", keyBorder: "#145374", textColor: "#e0e0e0", highlight: "#0ea5e9" },
  { name: "Raise", accent: "#10b981", keyCap: "#0a2e1f", keyBorder: "#136e44", textColor: "#e0e0e0", highlight: "#10b981" },
  { name: "Adjust", accent: "#f59e0b", keyCap: "#2e1f0a", keyBorder: "#6e4413", textColor: "#e0e0e0", highlight: "#f59e0b" },
];

const ZMK_KEYS = [
  "A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z",
  "N1","N2","N3","N4","N5","N6","N7","N8","N9","N0",
  "RET","ENT","ESC","BSPC","TAB","SPC","MINUS","EQUAL","LBKT","RBKT",
  "BSLH","SEMI","SQT","GRAVE","COMMA","DOT","FSLH",
  "CAPS","F1","F2","F3","F4","F5","F6","F7","F8","F9","F10","F11","F12",
  "PSCRN","SLCK","PAUSE","INS","HOME","PG_UP","DEL","END","PG_DN",
  "RIGHT","LEFT","DOWN","UP",
  "LSHFT","RSHFT","LCTRL","RCTRL","LALT","RALT","LGUI","RGUI",
  "LC()","RC()","LA()","RA()","LG()","RG()","LS()","RS()",
  "C_VOL_UP","C_VOL_DN","C_MUTE","C_PP","C_NEXT","C_PREV","C_BRI_UP","C_BRI_DN",
  "BT_CLR","BT_SEL 0","BT_SEL 1","BT_SEL 2","BT_SEL 3","BT_SEL 4",
  "&trans","&none","&bootloader","&sys_reset",
  "KP_N0","KP_N1","KP_N2","KP_N3","KP_N4","KP_N5","KP_N6","KP_N7","KP_N8","KP_N9",
  "KP_PLUS","KP_MINUS","KP_MULTIPLY","KP_DIVIDE","KP_DOT","KP_ENTER",
];

const DISPLAY_MAP = {
  BSPC:"\u232B",TAB:"\u21E5",SPC:"\u2423",ENT:"\u23CE",RET:"\u23CE",
  ESC:"\u238B",SHFT:"\u21E7",LSHFT:"\u21E7L",RSHFT:"\u21E7R",
  LCTRL:"\u2303L",RCTRL:"\u2303R",LCTL:"\u2303L",RCTL:"\u2303R",
  LALT:"\u2325L",RALT:"\u2325R",ALT:"\u2325",
  LGUI:"\u2318L",RGUI:"\u2318R",GUI:"\u2318",
  FN:"Fn",CAPS:"\u21EA",
  UP:"\u2191",DOWN:"\u2193",LEFT:"\u2190",RIGHT:"\u2192",
  HOME:"\u21F1",END:"\u21F2",PG_UP:"\u21DE",PG_DN:"\u21DF",
  DEL:"\u2326",INS:"Ins","&trans":"\u25BD","&none":"\u2715",
  "C_VOL_UP":"Vol+","C_VOL_DN":"Vol-","C_MUTE":"Mute",
  "C_PP":"Play","C_NEXT":"Next","C_PREV":"Prev","BT_CLR":"BT\u2205",
};

function getDisplayLabel(label) {
  if (!label) return "";
  if (DISPLAY_MAP[label]) return DISPLAY_MAP[label];
  if (label.startsWith("BT_SEL")) return "BT" + label.split(" ")[1];
  if (label.startsWith("KP_N")) return label.replace("KP_N","K");
  if (label.startsWith("KP_")) return label.replace("KP_","K");
  return label;
}

const MODE_BIND = "bind";
const MODE_MOVE = "move";

function App() {
  const [layout, setLayout] = useState(DEFAULT_LAYOUT);
  const [layers, setLayers] = useState(() => {
    const base = DEFAULT_LAYOUT.map(k => k.label);
    return [base, base.map(() => "&trans"), base.map(() => "&trans"), base.map(() => "&none")];
  });
  const [activeLayer, setActiveLayer] = useState(0);
  const [selectedKey, setSelectedKey] = useState(null);
  const [searchFilter, setSearchFilter] = useState("");
  const [mode, setMode] = useState(MODE_BIND);
  const [showExport, setShowExport] = useState(false);
  const [exportText, setExportText] = useState("");
  const [showImport, setShowImport] = useState(false);
  const [importText, setImportText] = useState("");
  const [notification, setNotification] = useState(null);
  const [snapToGrid, setSnapToGrid] = useState(true);
  const dragRef = useRef(null);
  const didDragRef = useRef(false);
  const svgRef = useRef(null);
  const fileInputRef = useRef(null);

  const theme = LAYER_COLORS[activeLayer] || LAYER_COLORS[0];
  const notify = useCallback((msg) => { setNotification(msg); setTimeout(() => setNotification(null), 2500); }, []);

  /* persist */
  useEffect(() => { try { const s1 = JSON.parse(localStorage.getItem("km_layers")); const s2 = JSON.parse(localStorage.getItem("km_layout")); if (s1) setLayers(s1); if (s2) setLayout(s2); } catch {} }, []);
  useEffect(() => { try { localStorage.setItem("km_layers", JSON.stringify(layers)); localStorage.setItem("km_layout", JSON.stringify(layout)); } catch {} }, [layers, layout]);

  /* keyboard */
  useEffect(() => {
    const h = (e) => { if (e.key === "Escape") { setSelectedKey(null); setShowExport(false); setShowImport(false); } };
    window.addEventListener("keydown", h); return () => window.removeEventListener("keydown", h);
  }, []);

  /* svg coords */
  function svgPoint(cx, cy) {
    const svg = svgRef.current;
    if (!svg) return { x: 0, y: 0 };
    const pt = svg.createSVGPoint();
    pt.x = cx; pt.y = cy;
    const p = pt.matrixTransform(svg.getScreenCTM().inverse());
    return { x: p.x, y: p.y };
  }

  /* drag */
  function onKeyMouseDown(e, index) {
    if (mode !== MODE_MOVE) return;
    e.preventDefault();
    e.stopPropagation();
    const mp = svgPoint(e.clientX, e.clientY);
    dragRef.current = { index, startMouse: mp, startX: layout[index].x, startY: layout[index].y };
    didDragRef.current = false;
    setSelectedKey(index);
  }

  function onSvgMouseMove(e) {
    if (!dragRef.current) return;
    const d = dragRef.current;
    const mp = svgPoint(e.clientX, e.clientY);
    const dx = (mp.x - d.startMouse.x) / STEP;
    const dy = (mp.y - d.startMouse.y) / STEP;
    if (Math.abs(dx) > 0.02 || Math.abs(dy) > 0.02) didDragRef.current = true;
    let nx = d.startX + dx;
    let ny = d.startY + dy;
    if (snapToGrid) { nx = Math.round(nx * 20) / 20; ny = Math.round(ny * 20) / 20; }
    setLayout(prev => { const n = [...prev]; n[d.index] = { ...n[d.index], x: nx, y: ny }; return n; });
  }

  function onSvgMouseUp() { dragRef.current = null; }

  /* click */
  function handleKeyClick(index) {
    if (mode === MODE_MOVE && didDragRef.current) return;
    setSelectedKey(selectedKey === index ? null : index);
    setSearchFilter("");
  }

  /* binding */
  function handleBindingChange(kc) {
    if (selectedKey === null) return;
    setLayers(prev => { const n = prev.map(l => [...l]); n[activeLayer][selectedKey] = kc; return n; });
    setSelectedKey(null); setSearchFilter("");
  }

  /* position controls */
  function updateKeyProp(prop, value) {
    if (selectedKey === null) return;
    setLayout(prev => { const n = [...prev]; n[selectedKey] = { ...n[selectedKey], [prop]: value }; return n; });
  }
  function nudgeKey(prop, delta) {
    if (selectedKey === null) return;
    setLayout(prev => { const n = [...prev]; const old = n[selectedKey][prop] || 0; n[selectedKey] = { ...n[selectedKey], [prop]: Math.round((old + delta) * 100) / 100 }; return n; });
  }

  /* export */
  function generateLayoutJSON() { return JSON.stringify({ layouts: { LAYOUT: { layout } } }, null, 2); }
  function generateZMK() {
    let out = "// ZMK Keymap - Dactyl Manuform 4x6\n\n";
    layers.forEach((layer, li) => {
      const nm = (LAYER_COLORS[li]?.name || `Layer${li}`).toLowerCase();
      out += `  ${nm}_layer {\n    label = "${LAYER_COLORS[li]?.name || nm}";\n    bindings = <\n`;
      const rows = {};
      layout.forEach((k, i) => { const rk = `${k.row}-${k.x < 7 ? "L" : "R"}`; if (!rows[rk]) rows[rk] = []; rows[rk].push({ ...k, idx: i }); });
      const fmt = b => b.startsWith("&") ? b : b.includes("BT_") ? `&bt ${b}` : `&kp ${b}`;
      Object.keys(rows).sort().forEach(rk => { out += `      ${rows[rk].sort((a,b) => a.x - b.x).map(k => fmt(layer[k.idx])).join("  ")}\n`; });
      out += `    >;\n  };\n\n`;
    });
    return out;
  }

  /* import */
  function doImport(json) {
    try {
      const d = JSON.parse(json);
      if (d.layouts?.LAYOUT?.layout) {
        setLayout(d.layouts.LAYOUT.layout);
        const nb = d.layouts.LAYOUT.layout.map(k => k.label);
        setLayers(prev => { const n = [...prev]; n[0] = nb; for (let i = 1; i < n.length; i++) { const o = n[i]; n[i] = nb.map((_, j) => o[j] || "&trans"); } return n; });
        notify("Layout imported!"); return true;
      } else { notify("Invalid format"); return false; }
    } catch { notify("Invalid JSON"); return false; }
  }
  function handleImportFile(e) { const f = e.target.files[0]; if (!f) return; const r = new FileReader(); r.onload = ev => doImport(ev.target.result); r.readAsText(f); e.target.value = ""; }
  function handleAddLayer() {
    if (layers.length >= 6) return notify("Max 6 layers");
    setLayers(prev => [...prev, layout.map(() => "&trans")]);
    if (!LAYER_COLORS[layers.length]) LAYER_COLORS.push({ name: `Layer ${layers.length}`, accent: "#a855f7", keyCap: "#1e103a", keyBorder: "#4c1d95", textColor: "#e0e0e0", highlight: "#a855f7" });
  }

  /* viewBox */
  const allX = layout.map(k => k.x * STEP);
  const allY = layout.map(k => k.y * STEP);
  const minX = Math.min(...allX); const minY = Math.min(...allY);
  const maxX = Math.max(...allX) + UNIT; const maxY = Math.max(...allY) + UNIT;
  const pad = 40;
  const viewBox = `${minX - pad} ${minY - pad} ${maxX - minX + pad * 2} ${maxY - minY + pad * 2}`;

  const sel = selectedKey !== null ? layout[selectedKey] : null;
  const filteredKeys = ZMK_KEYS.filter(k => k.toLowerCase().includes(searchFilter.toLowerCase()));

  const btnS = { padding: "6px 14px", borderRadius: 6, border: `1px solid ${theme.keyBorder}`, background: "rgba(255,255,255,0.04)", color: "#ccc", fontSize: 12, fontFamily: "'JetBrains Mono', monospace", cursor: "pointer" };
  const btnA = { ...btnS, background: theme.accent, color: "#fff", borderColor: theme.accent };
  const btnSm = { ...btnS, padding: "4px 10px", fontSize: 14, border: "1px solid rgba(255,255,255,0.1)", background: "transparent", color: "#888" };

  return (
    <div style={{ minHeight: "100vh", background: "linear-gradient(145deg, #1a1a2e 0%, #0d0d1a 50%, #0a0a15 100%)", color: theme.textColor, fontFamily: "'JetBrains Mono', monospace" }}>

      {/* HEADER */}
      <div style={{ padding: "12px 24px", display: "flex", alignItems: "center", justifyContent: "space-between", borderBottom: `1px solid ${theme.keyBorder}`, background: "rgba(0,0,0,0.3)" }}>
        <div style={{ display: "flex", alignItems: "center", gap: 12 }}>
          <div style={{ width: 32, height: 32, borderRadius: 8, background: `linear-gradient(135deg, ${theme.accent}, ${theme.accent}88)`, display: "flex", alignItems: "center", justifyContent: "center", fontSize: 16 }}>&#9000;</div>
          <div>
            <div style={{ fontSize: 15, fontWeight: 600 }}>Dactyl Manuform 4×6</div>
            <div style={{ fontSize: 11, color: "#888" }}>{layout.length} keys &bull; {layers.length} layers</div>
          </div>
        </div>
        <div style={{ display: "flex", gap: 8 }}>
          <button onClick={() => fileInputRef.current?.click()} style={btnS}>Import JSON</button>
          <button onClick={() => setShowImport(true)} style={btnS}>Paste JSON</button>
          <button onClick={() => { setExportText(generateLayoutJSON()); setShowExport(true); }} style={btnS}>Export Layout</button>
          <button onClick={() => { setExportText(generateZMK()); setShowExport(true); }} style={btnA}>Export ZMK</button>
          <input ref={fileInputRef} type="file" accept=".json" onChange={handleImportFile} style={{ display: "none" }} />
        </div>
      </div>

      {/* TOOLBAR */}
      <div style={{ padding: "10px 24px", display: "flex", alignItems: "center", justifyContent: "space-between", background: "rgba(0,0,0,0.15)", borderBottom: "1px solid rgba(255,255,255,0.05)" }}>
        <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
          <span style={{ fontSize: 11, color: "#555", marginRight: 4 }}>LAYERS</span>
          {layers.map((_, li) => {
            const lc = LAYER_COLORS[li] || LAYER_COLORS[0];
            return (<button key={li} onClick={() => { setActiveLayer(li); setSelectedKey(null); }}
              style={{ padding: "5px 14px", borderRadius: 6, border: `1.5px solid ${li === activeLayer ? lc.accent : "rgba(255,255,255,0.08)"}`, background: li === activeLayer ? `${lc.accent}22` : "transparent", color: li === activeLayer ? lc.accent : "#888", fontSize: 12, fontWeight: li === activeLayer ? 600 : 400, cursor: "pointer", fontFamily: "inherit" }}>{lc.name}</button>);
          })}
          <button onClick={handleAddLayer} style={btnSm}>+</button>
          {layers.length > 1 && <button onClick={() => { if (activeLayer === layers.length - 1) setActiveLayer(activeLayer - 1); setLayers(p => p.slice(0, -1)); }} style={btnSm}>&minus;</button>}
        </div>
        <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
          <span style={{ fontSize: 11, color: "#555", marginRight: 4 }}>MODE</span>
          {[MODE_BIND, MODE_MOVE].map(m => (
            <button key={m} onClick={() => { setMode(m); setSelectedKey(null); }}
              style={{ padding: "5px 14px", borderRadius: 6, border: `1.5px solid ${mode === m ? "#fff" : "rgba(255,255,255,0.08)"}`, background: mode === m ? "rgba(255,255,255,0.12)" : "transparent", color: mode === m ? "#fff" : "#888", fontSize: 12, fontWeight: mode === m ? 600 : 400, cursor: "pointer", fontFamily: "inherit" }}>
              {m === MODE_BIND ? "\u2328 Bind" : "\u2725 Move"}
            </button>
          ))}
          {mode === MODE_MOVE && (
            <label style={{ display: "flex", alignItems: "center", gap: 5, fontSize: 11, color: "#888", cursor: "pointer", marginLeft: 8 }}>
              <input type="checkbox" checked={snapToGrid} onChange={e => setSnapToGrid(e.target.checked)} style={{ accentColor: theme.accent }} />
              Snap 0.05
            </label>
          )}
        </div>
      </div>

      {/* KEYBOARD SVG */}
      <div style={{ display: "flex", flexDirection: "column", alignItems: "center", padding: "20px 24px" }}>
        <div style={{ background: "rgba(0,0,0,0.25)", borderRadius: 16, padding: "20px 28px", border: "1px solid rgba(255,255,255,0.06)", boxShadow: "0 8px 32px rgba(0,0,0,0.4)", width: "100%", overflow: "auto" }}>
          <svg ref={svgRef} viewBox={viewBox} style={{ display: "block", width: "100%", cursor: mode === MODE_MOVE ? (dragRef.current ? "grabbing" : "default") : "default" }}
            onMouseMove={onSvgMouseMove} onMouseUp={onSvgMouseUp} onMouseLeave={onSvgMouseUp}>

            {/* center split */}
            <line x1={7 * STEP} y1={minY - pad} x2={7 * STEP} y2={maxY + pad} stroke={theme.accent} strokeWidth={1} strokeDasharray="4 6" opacity={0.15} />
            <text x={2.5 * STEP} y={minY - 14} textAnchor="middle" fill="#555" fontSize={10} fontFamily="inherit">LEFT</text>
            <text x={11.5 * STEP} y={minY - 14} textAnchor="middle" fill="#555" fontSize={10} fontFamily="inherit">RIGHT</text>

            {/* grid dots in move mode */}
            {mode === MODE_MOVE && Array.from({ length: 16 }, (_, gx) =>
              Array.from({ length: 8 }, (_, gy) => (
                <circle key={`${gx}-${gy}`} cx={gx * STEP + UNIT / 2} cy={gy * STEP + UNIT / 2} r={1.2} fill="rgba(255,255,255,0.05)" />
              ))
            )}

            {/* keys */}
            {layout.map((k, i) => {
              const binding = layers[activeLayer]?.[i] || k.label;
              const dl = getDisplayLabel(binding);
              const px = k.x * STEP;
              const py = k.y * STEP;
              const rot = k.r || 0;
              const isSel = selectedKey === i;
              const isThumb = k.row === 3 && k.col >= 3 && k.col <= 8;
              const fs = dl.length > 4 ? 10 : dl.length > 2 ? 12 : 14;

              let transform = "";
              if (rot !== 0) {
                const rpx = (k.rx != null ? k.rx : k.x + 0.5) * STEP;
                const rpy = (k.ry != null ? k.ry : k.y + 0.5) * STEP;
                transform = `rotate(${rot}, ${rpx}, ${rpy})`;
              }

              return (
                <g key={i} transform={transform}
                  onMouseDown={e => onKeyMouseDown(e, i)}
                  onClick={() => handleKeyClick(i)}
                  style={{ cursor: mode === MODE_MOVE ? "grab" : "pointer" }}>

                  {isSel && <rect x={px - 4} y={py - 4} width={UNIT + 6} height={UNIT + 6} rx={KEY_R + 3} fill="none" stroke={theme.accent} strokeWidth={2} opacity={0.35}>
                    <animate attributeName="opacity" values="0.35;0.12;0.35" dur="2s" repeatCount="indefinite" />
                  </rect>}

                  <rect x={px + 1} y={py + 2} width={UNIT - 2} height={UNIT - 2} rx={KEY_R} fill="rgba(0,0,0,0.4)" />
                  <rect x={px} y={py} width={UNIT - 2} height={UNIT - 2} rx={KEY_R}
                    fill={isSel ? (mode === MODE_MOVE ? "#2a1a4e" : theme.highlight) : theme.keyCap}
                    stroke={isSel ? theme.highlight : theme.keyBorder}
                    strokeWidth={isSel ? 2.5 : 1.5} />
                  <rect x={px + 4} y={py + 3} width={UNIT - 10} height={UNIT - 10} rx={KEY_R - 2}
                    fill="none" stroke={isSel ? "rgba(255,255,255,0.2)" : "rgba(255,255,255,0.06)"} strokeWidth={0.8} />
                  <text x={px + (UNIT - 2) / 2} y={py + (UNIT - 2) / 2 + 1} textAnchor="middle" dominantBaseline="central"
                    fill={isSel ? "#fff" : theme.textColor} fontSize={fs} fontFamily="'JetBrains Mono', monospace"
                    fontWeight={isSel ? 700 : 500} style={{ userSelect: "none", pointerEvents: "none" }}>{dl}</text>
                  {isThumb && <circle cx={px + UNIT - 10} cy={py + 8} r={2.5} fill={theme.accent} opacity={0.5} />}
                  {mode === MODE_MOVE && isSel && (
                    <text x={px + (UNIT - 2) / 2} y={py + UNIT + 12} textAnchor="middle" fill={theme.accent} fontSize={8} fontFamily="inherit" opacity={0.7}>
                      {k.x.toFixed(2)}, {k.y.toFixed(2)}{rot ? ` r:${rot}\u00B0` : ""}
                    </text>
                  )}
                </g>
              );
            })}
          </svg>
        </div>

        {/* BIND PANEL */}
        {selectedKey !== null && mode === MODE_BIND && (
          <div style={{ marginTop: 16, background: "rgba(0,0,0,0.35)", borderRadius: 12, padding: "18px 24px", border: `1px solid ${theme.accent}44`, width: "100%", animation: "slideUp 0.2s ease" }}>
            <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", marginBottom: 12 }}>
              <span style={{ fontSize: 13, color: "#aaa" }}>
                Key <span style={{ color: theme.accent, fontWeight: 600 }}>[{sel.row},{sel.col}]</span>
                {" \u2192 "}<span style={{ color: "#fff", fontWeight: 600 }}>{layers[activeLayer][selectedKey]}</span>
              </span>
              <div style={{ display: "flex", gap: 6 }}>
                <button onClick={() => handleBindingChange("&trans")} style={btnS}>{"\u25BD"} Trans</button>
                <button onClick={() => handleBindingChange("&none")} style={btnS}>{"\u2715"} None</button>
                <button onClick={() => { setSelectedKey(null); setSearchFilter(""); }} style={btnS}>Close</button>
              </div>
            </div>
            <input type="text" placeholder="Search keycodes..." value={searchFilter} onChange={e => setSearchFilter(e.target.value)} autoFocus
              style={{ width: "100%", padding: "10px 14px", borderRadius: 8, border: `1px solid ${theme.keyBorder}`, background: "rgba(0,0,0,0.3)", color: "#fff", fontSize: 13, fontFamily: "inherit", outline: "none", boxSizing: "border-box", marginBottom: 12 }} />
            <div style={{ display: "flex", flexWrap: "wrap", gap: 5, maxHeight: 200, overflowY: "auto", paddingRight: 8 }}>
              {filteredKeys.map(kc => {
                const cur = layers[activeLayer][selectedKey] === kc;
                return (<button key={kc} onClick={() => handleBindingChange(kc)}
                  style={{ padding: "6px 10px", borderRadius: 6, border: `1px solid ${cur ? theme.accent : "rgba(255,255,255,0.08)"}`, background: cur ? `${theme.accent}33` : "rgba(255,255,255,0.04)", color: cur ? theme.accent : "#ccc", fontSize: 11, fontFamily: "inherit", cursor: "pointer", fontWeight: cur ? 600 : 400 }}>
                  {getDisplayLabel(kc)} <span style={{ color: "#666", marginLeft: 3 }}>{kc}</span>
                </button>);
              })}
            </div>
          </div>
        )}

        {/* MOVE PANEL */}
        {selectedKey !== null && mode === MODE_MOVE && (
          <div style={{ marginTop: 16, background: "rgba(0,0,0,0.35)", borderRadius: 12, padding: "18px 24px", border: `1px solid ${theme.accent}44`, width: "100%", animation: "slideUp 0.2s ease" }}>
            <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", marginBottom: 16 }}>
              <span style={{ fontSize: 14, fontWeight: 600, color: "#fff" }}>
                Position: <span style={{ color: theme.accent }}>{sel.label}</span>
                <span style={{ color: "#666", fontWeight: 400, marginLeft: 8 }}>[row {sel.row}, col {sel.col}]</span>
              </span>
              <button onClick={() => setSelectedKey(null)} style={btnS}>Close</button>
            </div>

            <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fit, minmax(220px, 1fr))", gap: 16 }}>
              {/* X */}
              <div style={propGroupStyle}>
                <label style={propLabelStyle}>X Position</label>
                <div style={propRowStyle}>
                  <button onClick={() => nudgeKey("x", -0.25)} style={nudgeBtnStyle}>&minus;.25</button>
                  <button onClick={() => nudgeKey("x", -0.05)} style={nudgeBtnStyle}>&minus;</button>
                  <input type="number" value={sel.x} step={0.05} onChange={e => updateKeyProp("x", parseFloat(e.target.value) || 0)} style={numInputStyle(theme)} />
                  <button onClick={() => nudgeKey("x", 0.05)} style={nudgeBtnStyle}>+</button>
                  <button onClick={() => nudgeKey("x", 0.25)} style={nudgeBtnStyle}>+.25</button>
                </div>
              </div>
              {/* Y */}
              <div style={propGroupStyle}>
                <label style={propLabelStyle}>Y Position</label>
                <div style={propRowStyle}>
                  <button onClick={() => nudgeKey("y", -0.25)} style={nudgeBtnStyle}>&minus;.25</button>
                  <button onClick={() => nudgeKey("y", -0.05)} style={nudgeBtnStyle}>&minus;</button>
                  <input type="number" value={sel.y} step={0.05} onChange={e => updateKeyProp("y", parseFloat(e.target.value) || 0)} style={numInputStyle(theme)} />
                  <button onClick={() => nudgeKey("y", 0.05)} style={nudgeBtnStyle}>+</button>
                  <button onClick={() => nudgeKey("y", 0.25)} style={nudgeBtnStyle}>+.25</button>
                </div>
              </div>
              {/* Rotation */}
              <div style={propGroupStyle}>
                <label style={propLabelStyle}>Rotation (&deg;)</label>
                <div style={propRowStyle}>
                  <button onClick={() => nudgeKey("r", -5)} style={nudgeBtnStyle}>&minus;5</button>
                  <button onClick={() => nudgeKey("r", -1)} style={nudgeBtnStyle}>&minus;1</button>
                  <input type="number" value={sel.r || 0} step={1} onChange={e => updateKeyProp("r", parseFloat(e.target.value) || 0)} style={numInputStyle(theme)} />
                  <button onClick={() => nudgeKey("r", 1)} style={nudgeBtnStyle}>+1</button>
                  <button onClick={() => nudgeKey("r", 5)} style={nudgeBtnStyle}>+5</button>
                </div>
                <input type="range" min={-90} max={90} value={sel.r || 0} onChange={e => updateKeyProp("r", parseFloat(e.target.value))}
                  style={{ width: "100%", marginTop: 8, accentColor: theme.accent }} />
              </div>
              {/* Rotation origin */}
              <div style={propGroupStyle}>
                <label style={propLabelStyle}>Rotation Origin (rx, ry)</label>
                <div style={{ display: "flex", gap: 8 }}>
                  <div style={{ flex: 1 }}>
                    <span style={{ fontSize: 10, color: "#666" }}>rx</span>
                    <input type="number" value={sel.rx != null ? sel.rx : ""} step={0.5} placeholder="auto"
                      onChange={e => updateKeyProp("rx", e.target.value === "" ? undefined : parseFloat(e.target.value))}
                      style={{ ...numInputStyle(theme), width: "100%" }} />
                  </div>
                  <div style={{ flex: 1 }}>
                    <span style={{ fontSize: 10, color: "#666" }}>ry</span>
                    <input type="number" value={sel.ry != null ? sel.ry : ""} step={0.5} placeholder="auto"
                      onChange={e => updateKeyProp("ry", e.target.value === "" ? undefined : parseFloat(e.target.value))}
                      style={{ ...numInputStyle(theme), width: "100%" }} />
                  </div>
                </div>
              </div>
            </div>

            <div style={{ marginTop: 14, display: "flex", gap: 8, flexWrap: "wrap" }}>
              <button onClick={() => updateKeyProp("r", 0)} style={btnS}>Reset Rotation</button>
              <button onClick={() => { updateKeyProp("x", Math.round(sel.x)); updateKeyProp("y", Math.round(sel.y)); }} style={btnS}>Snap to Grid</button>
              <button onClick={() => { navigator.clipboard.writeText(JSON.stringify(layout[selectedKey], null, 2)).then(() => notify("Key JSON copied!")); }} style={btnS}>Copy Key JSON</button>
            </div>
          </div>
        )}

        {selectedKey === null && (
          <div style={{ marginTop: 14, fontSize: 12, color: "#555", textAlign: "center" }}>
            {mode === MODE_BIND
              ? "Click a key to edit its binding \u2022 Use layer tabs to switch layers"
              : "Drag keys to reposition \u2022 Click for fine controls & rotation \u2022 Export Layout to save positions"}
          </div>
        )}
      </div>

      {/* EXPORT MODAL */}
      {showExport && (
        <div style={modalOverlay} onClick={() => setShowExport(false)}>
          <div style={modalBox(theme)} onClick={e => e.stopPropagation()}>
            <div style={{ display: "flex", justifyContent: "space-between", marginBottom: 12 }}>
              <span style={{ fontWeight: 600, fontSize: 14 }}>Export</span>
              <button onClick={() => setShowExport(false)} style={btnSm}>{"\u2715"}</button>
            </div>
            <textarea value={exportText} readOnly style={taStyle(theme)} />
            <button onClick={() => { navigator.clipboard.writeText(exportText).then(() => notify("Copied!")); }}
              style={{ ...btnA, marginTop: 10, width: "100%" }}>Copy to Clipboard</button>
          </div>
        </div>
      )}

      {/* IMPORT MODAL */}
      {showImport && (
        <div style={modalOverlay} onClick={() => setShowImport(false)}>
          <div style={modalBox(theme)} onClick={e => e.stopPropagation()}>
            <div style={{ display: "flex", justifyContent: "space-between", marginBottom: 12 }}>
              <span style={{ fontWeight: 600, fontSize: 14 }}>Paste Layout JSON</span>
              <button onClick={() => setShowImport(false)} style={btnSm}>{"\u2715"}</button>
            </div>
            <textarea value={importText} onChange={e => setImportText(e.target.value)} placeholder="Paste JSON..." style={taStyle(theme)} />
            <button onClick={() => { if (doImport(importText)) { setShowImport(false); setImportText(""); } }}
              style={{ ...btnA, marginTop: 10, width: "100%" }}>Import Layout</button>
          </div>
        </div>
      )}

      {notification && (
        <div style={{ position: "fixed", bottom: 24, left: "50%", transform: "translateX(-50%)", background: theme.accent, color: "#fff", padding: "10px 24px", borderRadius: 8, fontSize: 13, fontWeight: 500, boxShadow: "0 4px 20px rgba(0,0,0,0.5)", animation: "slideUp 0.2s ease", zIndex: 100, fontFamily: "inherit" }}>
          {notification}
        </div>
      )}
    </div>
  );
}

const propGroupStyle = { background: "rgba(255,255,255,0.03)", borderRadius: 8, padding: "10px 12px" };
const propLabelStyle = { fontSize: 11, color: "#888", display: "block", marginBottom: 6, fontWeight: 500 };
const propRowStyle = { display: "flex", alignItems: "center", gap: 4 };
const nudgeBtnStyle = { padding: "4px 8px", borderRadius: 4, border: "1px solid rgba(255,255,255,0.1)", background: "rgba(255,255,255,0.05)", color: "#ccc", fontSize: 11, fontFamily: "'JetBrains Mono', monospace", cursor: "pointer", minWidth: 32, textAlign: "center" };
const numInputStyle = (t) => ({ width: 72, padding: "6px 8px", borderRadius: 6, border: `1px solid ${t.keyBorder}`, background: "rgba(0,0,0,0.4)", color: "#fff", fontSize: 13, fontFamily: "inherit", outline: "none", textAlign: "center" });
const modalOverlay = { position: "fixed", inset: 0, background: "rgba(0,0,0,0.7)", display: "flex", alignItems: "center", justifyContent: "center", zIndex: 50, backdropFilter: "blur(4px)" };
const modalBox = (t) => ({ background: "#141425", borderRadius: 14, padding: 24, width: "90%", maxWidth: 600, border: `1px solid ${t.keyBorder}`, boxShadow: "0 20px 60px rgba(0,0,0,0.6)", fontFamily: "'JetBrains Mono', monospace", color: "#e0e0e0" });
const taStyle = (t) => ({ width: "100%", height: 320, background: "rgba(0,0,0,0.4)", color: "#ccc", border: `1px solid ${t.keyBorder}`, borderRadius: 8, padding: 12, fontSize: 11, fontFamily: "inherit", resize: "vertical", outline: "none", boxSizing: "border-box" });

ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>
</body>
</html>