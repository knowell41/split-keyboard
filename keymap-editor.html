<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Dactyl Manuform 4×6 — Keymap Editor</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { background: #0a0a15; overflow-x: hidden; }
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
  @keyframes slideUp { from { opacity:0; transform: translateY(8px); } to { opacity:1; transform: translateY(0); } }
  @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }
</style>
</head>
<body>
<div id="root"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>

<script type="text/babel">
const { useState, useRef, useCallback, useEffect } = React;

const UNIT = 58;
const GAP = 4;
const KEY_RADIUS = 7;

const DEFAULT_LAYOUT = [
  { label: "ESC", row: 0, col: 0, x: 0, y: 0.75 },
  { label: "Q", row: 0, col: 1, x: 1, y: 0.25 },
  { label: "W", row: 0, col: 2, x: 2, y: 0 },
  { label: "E", row: 0, col: 3, x: 3, y: 0.15 },
  { label: "R", row: 0, col: 4, x: 4, y: 0.3 },
  { label: "T", row: 0, col: 5, x: 5, y: 0.45 },
  { label: "Y", row: 0, col: 6, x: 9, y: 0.45 },
  { label: "U", row: 0, col: 7, x: 10, y: 0.3 },
  { label: "I", row: 0, col: 8, x: 11, y: 0.15 },
  { label: "O", row: 0, col: 9, x: 12, y: 0 },
  { label: "P", row: 0, col: 10, x: 13, y: 0.25 },
  { label: "BSPC", row: 0, col: 11, x: 14, y: 0.75 },
  { label: "TAB", row: 1, col: 0, x: 0, y: 1.75 },
  { label: "A", row: 1, col: 1, x: 1, y: 1.25 },
  { label: "S", row: 1, col: 2, x: 2, y: 1 },
  { label: "D", row: 1, col: 3, x: 3, y: 1.15 },
  { label: "F", row: 1, col: 4, x: 4, y: 1.3 },
  { label: "G", row: 1, col: 5, x: 5, y: 1.45 },
  { label: "H", row: 1, col: 6, x: 9, y: 1.45 },
  { label: "J", row: 1, col: 7, x: 10, y: 1.3 },
  { label: "K", row: 1, col: 8, x: 11, y: 1.15 },
  { label: "L", row: 1, col: 9, x: 12, y: 1 },
  { label: ";", row: 1, col: 10, x: 13, y: 1.25 },
  { label: "'", row: 1, col: 11, x: 14, y: 1.75 },
  { label: "SHFT", row: 2, col: 0, x: 0, y: 2.75 },
  { label: "Z", row: 2, col: 1, x: 1, y: 2.25 },
  { label: "X", row: 2, col: 2, x: 2, y: 2 },
  { label: "C", row: 2, col: 3, x: 3, y: 2.15 },
  { label: "V", row: 2, col: 4, x: 4, y: 2.3 },
  { label: "B", row: 2, col: 5, x: 5, y: 2.45 },
  { label: "N", row: 2, col: 6, x: 9, y: 2.45 },
  { label: "M", row: 2, col: 7, x: 10, y: 2.3 },
  { label: ",", row: 2, col: 8, x: 11, y: 2.15 },
  { label: ".", row: 2, col: 9, x: 12, y: 2 },
  { label: "/", row: 2, col: 10, x: 13, y: 2.25 },
  { label: "SHFT", row: 2, col: 11, x: 14, y: 2.75 },
  { label: "FN", row: 3, col: 1, x: 1, y: 3.75 },
  { label: "ALT", row: 3, col: 2, x: 2, y: 3.55 },
  { label: "GUI", row: 3, col: 3, x: 3, y: 3.45, r: 10, rx: 3.5, ry: 6 },
  { label: "SPC", row: 3, col: 4, x: 4, y: 3.45, r: 20, rx: 4.5, ry: 6 },
  { label: "LCTL", row: 3, col: 5, x: 5, y: 3.45, r: 30, rx: 5.5, ry: 6 },
  { label: "RCTL", row: 3, col: 6, x: 9, y: 3.45, r: -30, rx: 8.5, ry: 6 },
  { label: "ENT", row: 3, col: 7, x: 10, y: 3.45, r: -20, rx: 9.5, ry: 6 },
  { label: "ALT", row: 3, col: 8, x: 11, y: 3.45, r: -10, rx: 10.5, ry: 6 },
  { label: "[", row: 3, col: 9, x: 12, y: 3.55 },
  { label: "]", row: 3, col: 10, x: 13, y: 3.75 },
];

const LAYER_COLORS = [
  { name: "Base", bg: "#1a1a2e", accent: "#e94560", keyCap: "#16213e", keyBorder: "#0f3460", textColor: "#e0e0e0", highlight: "#e94560" },
  { name: "Lower", bg: "#1a1a2e", accent: "#0ea5e9", keyCap: "#0c2d48", keyBorder: "#145374", textColor: "#e0e0e0", highlight: "#0ea5e9" },
  { name: "Raise", bg: "#1a1a2e", accent: "#10b981", keyCap: "#0a2e1f", keyBorder: "#136e44", textColor: "#e0e0e0", highlight: "#10b981" },
  { name: "Adjust", bg: "#1a1a2e", accent: "#f59e0b", keyCap: "#2e1f0a", keyBorder: "#6e4413", textColor: "#e0e0e0", highlight: "#f59e0b" },
];

const ZMK_KEYS = [
  "A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z",
  "N1","N2","N3","N4","N5","N6","N7","N8","N9","N0",
  "RET","ENT","ESC","BSPC","TAB","SPC","MINUS","EQUAL","LBKT","RBKT",
  "BSLH","SEMI","SQT","GRAVE","COMMA","DOT","FSLH",
  "CAPS","F1","F2","F3","F4","F5","F6","F7","F8","F9","F10","F11","F12",
  "PSCRN","SLCK","PAUSE","INS","HOME","PG_UP","DEL","END","PG_DN",
  "RIGHT","LEFT","DOWN","UP",
  "LSHFT","RSHFT","LCTRL","RCTRL","LALT","RALT","LGUI","RGUI",
  "LC()","RC()","LA()","RA()","LG()","RG()","LS()","RS()",
  "C_VOL_UP","C_VOL_DN","C_MUTE","C_PP","C_NEXT","C_PREV",
  "C_BRI_UP","C_BRI_DN",
  "BT_CLR","BT_SEL 0","BT_SEL 1","BT_SEL 2","BT_SEL 3","BT_SEL 4",
  "&trans","&none","&bootloader","&sys_reset",
  "KP_N0","KP_N1","KP_N2","KP_N3","KP_N4","KP_N5","KP_N6","KP_N7","KP_N8","KP_N9",
  "KP_PLUS","KP_MINUS","KP_MULTIPLY","KP_DIVIDE","KP_DOT","KP_ENTER",
];

const DISPLAY_MAP = {
  BSPC: "\u232B", TAB: "\u21E5", SPC: "\u2423", ENT: "\u23CE", RET: "\u23CE",
  ESC: "\u238B", SHFT: "\u21E7", LSHFT: "\u21E7L", RSHFT: "\u21E7R",
  LCTRL: "\u2303L", RCTRL: "\u2303R", LCTL: "\u2303L", RCTL: "\u2303R",
  LALT: "\u2325L", RALT: "\u2325R", ALT: "\u2325",
  LGUI: "\u2318L", RGUI: "\u2318R", GUI: "\u2318",
  FN: "Fn", CAPS: "\u21EA",
  UP: "\u2191", DOWN: "\u2193", LEFT: "\u2190", RIGHT: "\u2192",
  HOME: "\u21F1", END: "\u21F2", PG_UP: "\u21DE", PG_DN: "\u21DF",
  DEL: "\u2326", INS: "Ins",
  "&trans": "\u25BD", "&none": "\u2715",
  "C_VOL_UP": "Vol+", "C_VOL_DN": "Vol-", "C_MUTE": "Mute",
  "C_PP": "Play", "C_NEXT": "Next", "C_PREV": "Prev",
  "BT_CLR": "BT\u2205",
};

function getDisplayLabel(label) {
  if (!label) return "";
  if (DISPLAY_MAP[label]) return DISPLAY_MAP[label];
  if (label.startsWith("BT_SEL")) return "BT" + label.split(" ")[1];
  if (label.startsWith("KP_N")) return label.replace("KP_N", "K");
  if (label.startsWith("KP_")) return label.replace("KP_", "K");
  return label;
}

function KeyCapSVG({ keyData, index, isSelected, onClick, theme, binding }) {
  const { x, y, r, rx, ry } = keyData;
  const displayLabel = getDisplayLabel(binding || keyData.label);
  const px = x * (UNIT + GAP);
  const py = y * (UNIT + GAP);

  const hasRotation = r !== undefined && r !== 0;
  let transform = "";
  if (hasRotation) {
    const rpx = (rx || x) * (UNIT + GAP);
    const rpy = (ry || y) * (UNIT + GAP);
    transform = `rotate(${r}, ${rpx + UNIT / 2}, ${rpy + UNIT / 2})`;
  }

  const isThumb = keyData.row === 3 && (keyData.col >= 3 && keyData.col <= 8);
  const fontSize = displayLabel.length > 4 ? 10 : displayLabel.length > 2 ? 12 : 14;

  return (
    <g transform={transform} onClick={() => onClick(index)} style={{ cursor: "pointer" }}>
      <rect x={px + 1} y={py + 2} width={UNIT - 2} height={UNIT - 2} rx={KEY_RADIUS} fill="rgba(0,0,0,0.4)" />
      <rect x={px} y={py} width={UNIT - 2} height={UNIT - 2} rx={KEY_RADIUS}
        fill={isSelected ? theme.highlight : theme.keyCap}
        stroke={isSelected ? theme.highlight : theme.keyBorder}
        strokeWidth={isSelected ? 2.5 : 1.5} />
      <rect x={px + 4} y={py + 3} width={UNIT - 10} height={UNIT - 10} rx={KEY_RADIUS - 2}
        fill="none" stroke={isSelected ? "rgba(255,255,255,0.25)" : "rgba(255,255,255,0.06)"} strokeWidth={0.8} />
      <text x={px + (UNIT - 2) / 2} y={py + (UNIT - 2) / 2 + 1}
        textAnchor="middle" dominantBaseline="central"
        fill={isSelected ? "#fff" : theme.textColor}
        fontSize={fontSize} fontFamily="'JetBrains Mono', monospace"
        fontWeight={isSelected ? 700 : 500}
        style={{ userSelect: "none", pointerEvents: "none" }}>
        {displayLabel}
      </text>
      {isThumb && <circle cx={px + UNIT - 10} cy={py + 8} r={2.5} fill={theme.accent} opacity={0.5} />}
    </g>
  );
}

function App() {
  const [layout, setLayout] = useState(DEFAULT_LAYOUT);
  const [layers, setLayers] = useState(() => {
    const base = DEFAULT_LAYOUT.map((k) => k.label);
    const lower = DEFAULT_LAYOUT.map(() => "&trans");
    const raise = DEFAULT_LAYOUT.map(() => "&trans");
    const adjust = DEFAULT_LAYOUT.map(() => "&none");
    return [base, lower, raise, adjust];
  });
  const [activeLayer, setActiveLayer] = useState(0);
  const [selectedKey, setSelectedKey] = useState(null);
  const [searchFilter, setSearchFilter] = useState("");
  const [showExport, setShowExport] = useState(false);
  const [exportText, setExportText] = useState("");
  const [showImport, setShowImport] = useState(false);
  const [importText, setImportText] = useState("");
  const [notification, setNotification] = useState(null);
  const fileInputRef = useRef(null);

  const notify = useCallback((msg) => {
    setNotification(msg);
    setTimeout(() => setNotification(null), 2500);
  }, []);

  const theme = LAYER_COLORS[activeLayer];

  const handleKeyClick = (index) => {
    setSelectedKey(selectedKey === index ? null : index);
    setSearchFilter("");
  };

  const handleBindingChange = (keyCode) => {
    if (selectedKey === null) return;
    setLayers((prev) => {
      const next = prev.map((l) => [...l]);
      next[activeLayer][selectedKey] = keyCode;
      return next;
    });
    setSelectedKey(null);
    setSearchFilter("");
  };

  const generateZMKSnippet = () => {
    let out = "// ZMK Keymap - Dactyl Manuform 4x6\n// Generated by Local Keymap Editor\n\n";
    layers.forEach((layer, li) => {
      const name = LAYER_COLORS[li].name.toLowerCase();
      out += `  ${name}_layer {\n    label = "${LAYER_COLORS[li].name}";\n    bindings = <\n`;
      const rows = {};
      layout.forEach((k, i) => {
        const rowKey = `${k.row}-${k.x < 7 ? "L" : "R"}`;
        if (!rows[rowKey]) rows[rowKey] = [];
        rows[rowKey].push({ ...k, idx: i });
      });
      const formatBinding = (b) => {
        if (b.startsWith("&")) return b;
        if (b.includes("BT_")) return `&bt ${b}`;
        return `&kp ${b}`;
      };
      Object.keys(rows).sort().forEach((rk) => {
        const keys = rows[rk].sort((a, b) => a.x - b.x);
        out += `      ${keys.map((k) => formatBinding(layer[k.idx])).join("  ")}\n`;
      });
      out += `    >;\n  };\n\n`;
    });
    return out;
  };

  const handleExport = () => { setExportText(generateZMKSnippet()); setShowExport(true); };

  const handleImportFile = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (ev) => {
      try {
        const json = JSON.parse(ev.target.result);
        if (json.layouts?.LAYOUT?.layout) {
          setLayout(json.layouts.LAYOUT.layout);
          const newBase = json.layouts.LAYOUT.layout.map((k) => k.label);
          setLayers((prev) => {
            const next = [...prev];
            next[0] = newBase;
            for (let i = 1; i < next.length; i++) {
              const old = next[i];
              next[i] = newBase.map((_, j) => old[j] || "&trans");
            }
            return next;
          });
          notify("Layout imported!");
        } else { notify("Invalid layout JSON format"); }
      } catch { notify("Failed to parse JSON"); }
    };
    reader.readAsText(file);
    e.target.value = "";
  };

  const handleImportSubmit = () => {
    try {
      const json = JSON.parse(importText);
      if (json.layouts?.LAYOUT?.layout) {
        setLayout(json.layouts.LAYOUT.layout);
        const newBase = json.layouts.LAYOUT.layout.map((k) => k.label);
        setLayers((prev) => {
          const next = [...prev];
          next[0] = newBase;
          for (let i = 1; i < next.length; i++) {
            const old = next[i];
            next[i] = newBase.map((_, j) => old[j] || "&trans");
          }
          return next;
        });
        setShowImport(false);
        setImportText("");
        notify("Layout imported!");
      } else { notify("Invalid format"); }
    } catch { notify("Invalid JSON"); }
  };

  const handleAddLayer = () => {
    if (layers.length >= 6) return notify("Max 6 layers");
    setLayers((prev) => [...prev, layout.map(() => "&trans")]);
    if (!LAYER_COLORS[layers.length]) {
      LAYER_COLORS.push({ name: `Layer ${layers.length}`, bg: "#1a1a2e", accent: "#a855f7", keyCap: "#1e103a", keyBorder: "#4c1d95", textColor: "#e0e0e0", highlight: "#a855f7" });
    }
  };

  const handleRemoveLayer = () => {
    if (layers.length <= 1) return;
    if (activeLayer === layers.length - 1) setActiveLayer(activeLayer - 1);
    setLayers((prev) => prev.slice(0, -1));
  };

  // Persist to localStorage
  useEffect(() => {
    try {
      const saved = JSON.parse(localStorage.getItem("km_layers"));
      const savedLayout = JSON.parse(localStorage.getItem("km_layout"));
      if (saved) setLayers(saved);
      if (savedLayout) setLayout(savedLayout);
    } catch {}
  }, []);

  useEffect(() => {
    try {
      localStorage.setItem("km_layers", JSON.stringify(layers));
      localStorage.setItem("km_layout", JSON.stringify(layout));
    } catch {}
  }, [layers, layout]);

  // Keyboard shortcut: Escape to deselect
  useEffect(() => {
    const handler = (e) => { if (e.key === "Escape") { setSelectedKey(null); setShowExport(false); setShowImport(false); } };
    window.addEventListener("keydown", handler);
    return () => window.removeEventListener("keydown", handler);
  }, []);

  const allX = layout.map((k) => k.x * (UNIT + GAP));
  const allY = layout.map((k) => k.y * (UNIT + GAP));
  const minX = Math.min(...allX);
  const minY = Math.min(...allY);
  const maxX = Math.max(...allX) + UNIT;
  const maxY = Math.max(...allY) + UNIT;
  const padX = 20, padY = 30;
  const vbW = maxX - minX + padX * 2;
  const vbH = maxY - minY + padY * 2;
  const viewBox = `${minX - padX} ${minY - padY} ${vbW} ${vbH}`;

  const filteredKeys = ZMK_KEYS.filter((k) => k.toLowerCase().includes(searchFilter.toLowerCase()));

  const btnStyle = {
    padding: "6px 14px", borderRadius: 6, border: `1px solid ${theme.keyBorder}`,
    background: "rgba(255,255,255,0.04)", color: "#ccc", fontSize: 12,
    fontFamily: "'JetBrains Mono', monospace", cursor: "pointer", transition: "all 0.15s",
  };
  const btnAccent = { ...btnStyle, background: theme.accent, color: "#fff", borderColor: theme.accent };
  const btnSmall = { ...btnStyle, padding: "4px 10px", fontSize: 14, border: "1px solid rgba(255,255,255,0.1)", background: "transparent", color: "#888" };

  return (
    <div style={{
      minHeight: "100vh",
      background: `linear-gradient(145deg, ${theme.bg} 0%, #0d0d1a 50%, #0a0a15 100%)`,
      color: theme.textColor,
      fontFamily: "'JetBrains Mono', 'Fira Code', monospace",
      transition: "background 0.4s ease",
    }}>
      {/* Header */}
      <div style={{
        padding: "16px 24px", display: "flex", alignItems: "center", justifyContent: "space-between",
        borderBottom: `1px solid ${theme.keyBorder}`, background: "rgba(0,0,0,0.3)", backdropFilter: "blur(10px)",
      }}>
        <div style={{ display: "flex", alignItems: "center", gap: 12 }}>
          <div style={{
            width: 32, height: 32, borderRadius: 8,
            background: `linear-gradient(135deg, ${theme.accent}, ${theme.accent}88)`,
            display: "flex", alignItems: "center", justifyContent: "center", fontSize: 16, fontWeight: 700,
          }}>&#9000;</div>
          <div>
            <div style={{ fontSize: 15, fontWeight: 600, letterSpacing: "-0.3px" }}>Dactyl Manuform 4×6</div>
            <div style={{ fontSize: 11, color: "#888", marginTop: 1 }}>Local Keymap Editor &bull; {layout.length} keys &bull; {layers.length} layers</div>
          </div>
        </div>
        <div style={{ display: "flex", gap: 8 }}>
          <button onClick={() => fileInputRef.current?.click()} style={btnStyle}>Import JSON</button>
          <button onClick={() => setShowImport(true)} style={btnStyle}>Paste JSON</button>
          <button onClick={handleExport} style={btnAccent}>Export ZMK</button>
          <input ref={fileInputRef} type="file" accept=".json" onChange={handleImportFile} style={{ display: "none" }} />
        </div>
      </div>

      {/* Layer tabs */}
      <div style={{
        padding: "12px 24px", display: "flex", alignItems: "center", gap: 8,
        background: "rgba(0,0,0,0.15)", borderBottom: "1px solid rgba(255,255,255,0.05)",
      }}>
        <span style={{ fontSize: 11, color: "#666", marginRight: 4 }}>LAYERS</span>
        {layers.map((_, li) => {
          const lc = LAYER_COLORS[li] || LAYER_COLORS[0];
          return (
            <button key={li} onClick={() => { setActiveLayer(li); setSelectedKey(null); }}
              style={{
                padding: "6px 16px", borderRadius: 6,
                border: `1.5px solid ${li === activeLayer ? lc.accent : "rgba(255,255,255,0.08)"}`,
                background: li === activeLayer ? `${lc.accent}22` : "transparent",
                color: li === activeLayer ? lc.accent : "#888",
                fontSize: 12, fontWeight: li === activeLayer ? 600 : 400,
                cursor: "pointer", fontFamily: "inherit", transition: "all 0.2s",
              }}>
              {lc.name}
            </button>
          );
        })}
        <button onClick={handleAddLayer} style={btnSmall}>+</button>
        {layers.length > 1 && <button onClick={handleRemoveLayer} style={btnSmall}>&minus;</button>}
      </div>

      {/* Keyboard */}
      <div style={{ display: "flex", flexDirection: "column", alignItems: "center", padding: "24px 24px" }}>
        <div style={{
          background: "rgba(0,0,0,0.25)", borderRadius: 16, padding: "24px 32px",
          border: "1px solid rgba(255,255,255,0.06)",
          boxShadow: "0 8px 32px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.03)",
          width: "100%", overflow: "auto",
        }}>
          <svg viewBox={viewBox} style={{ display: "block", width: "100%" }}>
            <line x1={7 * (UNIT + GAP)} y1={minY - padY} x2={7 * (UNIT + GAP)} y2={maxY + padY}
              stroke={theme.accent} strokeWidth={1} strokeDasharray="4 6" opacity={0.2} />
            <text x={2.5 * (UNIT + GAP)} y={minY - 10} textAnchor="middle" fill="#555" fontSize={10} fontFamily="inherit">LEFT</text>
            <text x={11.5 * (UNIT + GAP)} y={minY - 10} textAnchor="middle" fill="#555" fontSize={10} fontFamily="inherit">RIGHT</text>
            {layout.map((k, i) => (
              <KeyCapSVG key={i} keyData={k} index={i} isSelected={selectedKey === i}
                onClick={handleKeyClick} theme={theme} binding={layers[activeLayer]?.[i]} />
            ))}
          </svg>
        </div>

        {/* Key binding editor */}
        {selectedKey !== null && (
          <div style={{
            marginTop: 20, background: "rgba(0,0,0,0.35)", borderRadius: 12,
            padding: "20px 24px", border: `1px solid ${theme.accent}44`,
            width: "100%", animation: "slideUp 0.2s ease",
          }}>
            <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", marginBottom: 14 }}>
              <span style={{ fontSize: 13, color: "#aaa" }}>
                Key <span style={{ color: theme.accent, fontWeight: 600 }}>[{layout[selectedKey].row},{layout[selectedKey].col}]</span>
                {" \u2192 "}<span style={{ color: "#fff", fontWeight: 600 }}>{layers[activeLayer][selectedKey]}</span>
              </span>
              <div style={{ display: "flex", gap: 6 }}>
                <button onClick={() => handleBindingChange("&trans")} style={btnStyle}>{"\u25BD"} Trans</button>
                <button onClick={() => handleBindingChange("&none")} style={btnStyle}>{"\u2715"} None</button>
                <button onClick={() => { setSelectedKey(null); setSearchFilter(""); }} style={btnStyle}>Close</button>
              </div>
            </div>
            <input type="text" placeholder="Search keycodes..." value={searchFilter}
              onChange={(e) => setSearchFilter(e.target.value)} autoFocus
              style={{
                width: "100%", padding: "10px 14px", borderRadius: 8,
                border: `1px solid ${theme.keyBorder}`, background: "rgba(0,0,0,0.3)",
                color: "#fff", fontSize: 13, fontFamily: "inherit", outline: "none",
                boxSizing: "border-box", marginBottom: 12,
              }} />
            <div style={{ display: "flex", flexWrap: "wrap", gap: 5, maxHeight: 220, overflowY: "auto", paddingRight: 8 }}>
              {filteredKeys.map((kc) => {
                const isCurrent = layers[activeLayer][selectedKey] === kc;
                return (
                  <button key={kc} onClick={() => handleBindingChange(kc)}
                    style={{
                      padding: "6px 10px", borderRadius: 6,
                      border: `1px solid ${isCurrent ? theme.accent : "rgba(255,255,255,0.08)"}`,
                      background: isCurrent ? `${theme.accent}33` : "rgba(255,255,255,0.04)",
                      color: isCurrent ? theme.accent : "#ccc",
                      fontSize: 11, fontFamily: "inherit", cursor: "pointer",
                      fontWeight: isCurrent ? 600 : 400, transition: "all 0.15s",
                    }}>
                    {getDisplayLabel(kc)} <span style={{ color: "#666", marginLeft: 3 }}>{kc}</span>
                  </button>
                );
              })}
            </div>
          </div>
        )}

        {selectedKey === null && (
          <div style={{ marginTop: 16, fontSize: 12, color: "#555", textAlign: "center" }}>
            Click a key to edit its binding &bull; Use layer tabs to switch layers &bull; Press Escape to deselect
          </div>
        )}
      </div>

      {/* Export modal */}
      {showExport && (
        <div style={{ position: "fixed", inset: 0, background: "rgba(0,0,0,0.7)", display: "flex", alignItems: "center", justifyContent: "center", zIndex: 50, backdropFilter: "blur(4px)" }}
          onClick={() => setShowExport(false)}>
          <div style={{ background: "#141425", borderRadius: 14, padding: 24, width: "90%", maxWidth: 600,
            border: `1px solid ${theme.keyBorder}`, boxShadow: "0 20px 60px rgba(0,0,0,0.6)",
            fontFamily: "'JetBrains Mono', monospace", color: "#e0e0e0" }}
            onClick={(e) => e.stopPropagation()}>
            <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 12 }}>
              <span style={{ fontWeight: 600, fontSize: 14 }}>ZMK Keymap Export</span>
              <button onClick={() => setShowExport(false)} style={btnSmall}>{"\u2715"}</button>
            </div>
            <textarea value={exportText} readOnly style={{
              width: "100%", height: 360, background: "rgba(0,0,0,0.4)", color: "#ccc",
              border: `1px solid ${theme.keyBorder}`, borderRadius: 8, padding: 12,
              fontSize: 11, fontFamily: "inherit", resize: "vertical", outline: "none", boxSizing: "border-box",
            }} />
            <button onClick={() => { navigator.clipboard.writeText(exportText).then(() => notify("Copied!")); }}
              style={{ ...btnAccent, marginTop: 10, width: "100%" }}>Copy to Clipboard</button>
          </div>
        </div>
      )}

      {/* Import modal */}
      {showImport && (
        <div style={{ position: "fixed", inset: 0, background: "rgba(0,0,0,0.7)", display: "flex", alignItems: "center", justifyContent: "center", zIndex: 50, backdropFilter: "blur(4px)" }}
          onClick={() => setShowImport(false)}>
          <div style={{ background: "#141425", borderRadius: 14, padding: 24, width: "90%", maxWidth: 600,
            border: `1px solid ${theme.keyBorder}`, boxShadow: "0 20px 60px rgba(0,0,0,0.6)",
            fontFamily: "'JetBrains Mono', monospace", color: "#e0e0e0" }}
            onClick={(e) => e.stopPropagation()}>
            <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 12 }}>
              <span style={{ fontWeight: 600, fontSize: 14 }}>Paste Layout JSON</span>
              <button onClick={() => setShowImport(false)} style={btnSmall}>{"\u2715"}</button>
            </div>
            <textarea value={importText} onChange={(e) => setImportText(e.target.value)}
              placeholder='Paste your layout JSON here...'
              style={{
                width: "100%", height: 260, background: "rgba(0,0,0,0.4)", color: "#ccc",
                border: `1px solid ${theme.keyBorder}`, borderRadius: 8, padding: 12,
                fontSize: 11, fontFamily: "inherit", resize: "vertical", outline: "none", boxSizing: "border-box",
              }} />
            <button onClick={handleImportSubmit} style={{ ...btnAccent, marginTop: 10, width: "100%" }}>Import Layout</button>
          </div>
        </div>
      )}

      {/* Toast */}
      {notification && (
        <div style={{
          position: "fixed", bottom: 24, left: "50%", transform: "translateX(-50%)",
          background: theme.accent, color: "#fff", padding: "10px 24px", borderRadius: 8,
          fontSize: 13, fontWeight: 500, boxShadow: "0 4px 20px rgba(0,0,0,0.5)",
          animation: "slideUp 0.2s ease", zIndex: 100, fontFamily: "inherit",
        }}>
          {notification}
        </div>
      )}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>
</body>
</html>